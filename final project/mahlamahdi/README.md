# image-processing-class
image processing class - 992

## Information
* ##### Teacher: Dr. Farzin Yaghmaee - [Contact](mailto:f_yaghmaee@semnan.ac.ir)
* ##### TA : Amir Shokri - [Contact](mailto:amirshokri@semnan.ac.ir)

### Student Info :
* Full name : ---
* github id : ---
* Email : ---
* Type : ---

<div dir="rtl">
 
 <h1> تمرین نهایی</h1>
 <hr>
 
 <h3> برنامه ای که در تمرین شماره ی 19 در کلاس توسط بنده حل شده است را از پوشه ی class دانلود کنید و کارهای زیر را روی آن انجام دهید</h3>  :
<ul>
 <li> روشی که انجام شده است را بهبود ببخشید.</li>
 <li>بخش های مختلف این برنامه را به صورت تابع در فایل جداگانه بسازید و آن ها را ساده تر فراخوانی کنید.
</li>
 <li>کپجاهای سخت تری ایجاد کنید فقط نکته اینکه از حوزه ی برنامه ی اولیه خارج نشوید
</li>
 <li>
  150 عکس با برنامه ی خود تولید کنید و آن را ذخیره کنید و بعد از ذخیره سازی آن در یک فایل خودتان با چشم کپچاها را تشخیص دهید و برچسب بزنید.
  </li>
 <h6>خروجی تابع ocr   و میزانی که متلب بتواند کپچای تصویری شما را شناسایی کند یکی از معیارهای مناسب برای سنجش برنامه ی شماست</h6>

</ul>

  ***
 
### توضیحات کلی برنامه:
در این برنامه جدای از مبحث تقسیم بندی برنامه به قسمت های مختلف سعی شده است تصاویر تولیدی به گونه ای باشند که تشخیص برای برنامه OCR متلب سخت باشد برای اینکار تصاویر کاراکترها به مقدار زاویه ای رندم دوران داده شده همچنین نویز فلفل نمکی نیز روی این تصاویر اعمال شده است و قسمتی از تصاویر به صورت نگاتیو در آورده شده و همچنین از کیفیت کارکترهای ورودی نیز کاسته شده است
برای تولید ۱۵۰ تصویر از حلقه تکرار ۱۵۰ تایی استفاده شده در هر حلقه کلیه عملیات فوق روی هر تصویر اعمال شده و از کاربر نیز درخواست میکند حدس خود از کارکترهای هر تصویر را که مشاهده می کند تایپ کند و در نهایت برنامه اطلاعات این ۱۵۰ تصویر را در آرایه ای ذخیره کرده و به فایل اکسل منتقل می کند مشاهده می گردد که در ۱۵۰ تصویر تولید شده دقت تشخیص برای متلب برابر صفر درصد و برای اینجانب ۸۷ درصد بوده است. همچنین در این برنامه برای ۱۵۰ کپچای تولیدی ابعاد تصویر و تعداد کاراکتر تصویر نیز به صورت رندم  در نظر گرفته شده است در بخش های بعد به توضیح جزئیات برنامه می پردازیم..
 
### توضیحات بخش های برنامه
***

 این قسمت باعث بسته شدن تمام پنجره ها ، ریست شدن تمام متغیر ها و پاک شدن کامند ویندو می گردد <br />
</div>

``` matlab

close all;         
clear all;         
clc;    

```
***
<div dir="rtl">

در این بخش ابتدا آرایه جهت ذخیره اطلاعات ۱۵۰ تصویر تولیدی و همچین متغیرهایی جهت معیار تشخیص درست کاربر و تابع OCR متلب تعریف گردیده است .

</div>

``` matlab
g=cell(150,7);
correct_ocr=0;
correct_guess=0;
g(1,:)={'Item','Captcha','Image','OCR','Correctness_OCR','Guess','Correctness_guess'};
 
```

***
<div dir="rtl">

در این بخش از برنامه قسمتی از حلقه تکرار ۱۵۰ تایی آورده شده است ابتدا تعداد کاراکتر ها به صورتی عددی رندم بین ۳ تا ۶ مشخص گردیده است سپس ابعاد تصویر نیر به صورت رندم تعریف می گردند. در ادامه برنامه توسط تابع main_func تصویر کپچا تولید شده و به همراه تکست کاراکترهای کپچا به برنامه اصلی باز گردانده می شود و در ادامه اطلاعات آن تصویر از جمله شماره - کد کپچا - ماتریس تصویر - خروجی تابع OCR متلب از این تصویر در آرایه ذخیره می گردد و سپس توسط دستورات شرطی درستی تشخیص تابع OCR متلب بررسی و نتیجه در آرایه ذخیره می گردد .

</div>

``` matlab
for i=1:150
    n=randi([3,6]);
    height=randi([100,400]);
    width=randi([400,n*150]);
    [pic,code]=main_func(n,height,width);
    g(i+1,1)={i};
    g(i+1,2)={code};
    g(i+1,3)={pic};
    d=ocr(pic);
    ocr_out=d.Text;
    g(i+1,4)={ocr_out};
    sc=size(code);
    so=size(ocr_out);
    if (sc(2)==so(2))
        if(ocr_out==char(code))
            correct_ocr=correct_ocr+1;
            g(i+1,5)={1};
        else
            g(i+1,5)={0};
        end  
    else
        g(i+1,5)={0};
    end
 
```

***
<div dir="rtl">

در این بخش از برنامه ادامه بخش های حلقه تکرار آورده شده است که در آن ابتدا از کاربر درخواست می کند حدس خود از تصویر کپچایی که توسط تابع main_func ایجاد شده را تایپ کند و این حدس را در ارایه ذخیره می کند سپس درستی حدس کاربر توسط دستورات شرطی با کارکترهای اصلی مقایسه گردیده و نتیجه تشخیص در آرایه ذخیره می گردد در انتهای حلقه تکرار نیز تصویر کپچای تولیدی با نام شماره تصویر در مسیر جاری با فرمت PNG ذخیره می گردد. در قسمت پایانی برنامه نیز کل اطلاعات موجود در ارایه در فایل اکسل به نام Result.xlsx ذخیره می گردد
</div>

``` matlab
    a=input("Enter The Captcha Letters no "+num2str(i)+": ",'s');
    g(i+1,6)={a};
    so=size(a);
    if (sc(2)==so(2))
        if(a==char(code))
            correct_guess=correct_guess+1;
            g(i+1,7)={1};
        else
            g(i+1,7)={0};
        end  
    else
        g(i+1,5)={0};
    end
    imwrite(pic,num2str(i)+".png");
end 
xlswrite('Result.xlsx',g);
```
***
#### توضیحات توابع استفاده شده در برنامه

***
### main_func :

<div dir="rtl">
این تابع وظیفه تولید تصویر کپچا در هر حلقه تکرار برنامه اصلی را برعهده دارد که خود این تابع نیز تعدادی تابع دیگر را در دل خود جای داده که در ادامه به توضیح آن می پردازیم . این تابع تعداد کاراکتر و ابعاد تصویر را به عنوان ورودی از تابع اصلی دریافت کرده  سپس توسط تابع get_ch ماتریسی شامل تصاویر هر یک از کارکترهای مورد نیاز آن تصویر کپچا و همچنین تکست آن کپچا را تولید می کند .

</div>


``` matlab
function [pic,code]=main_func(n,height,width)

%% parameters defining
[alphabet,code]=get_ch(n);
pic=zeros(height,width);
```
***


<div dir="rtl">
 
در ادامه توسط تابع join_char تصویری که حاصل از به هم چسباندن کلیه کارکتر هاست را تولید می کند و در ادامه بخشی از این تصویر که به صورت رندم انتخاب می گردد   توسط تابع rand_inv به نگاتیو تبدیل می شود بدینصورت که بخش های سیاه سفید شده و بخش های سفید سیاه می شود و در نهایت توسط تابع pepper_noise  میزان ۳۰ درصد نویز فلفل نمکی به تصویر اضافه می گردد. البته امکان اینکه میزان درصد نویز نیز رندم باشد وجود داشت که به همین میزان ۳۰ درصد اکتفا گردیده است . پس از اعمال نویز تصویر نهایی نمایش داده می شود. 

</div>

``` matlab
%% Joing random chars in a single image
pic=join_char(pic,alphabet,height,width,n);
% figure('Name',code);
% imshow(pic);

%% Invert a random part of the image
pic=rand_inv(pic,height,width);
% figure('Name',code);
% imshow(pic);

%% Add some salt & pepper noise to be more hard to read by OCR
pic=pepper_noise(pic,30);
%figure('Name',code);
imshow(pic);


end
```
***
### get_ch :

<div dir="rtl">

این تابع تعداد کاراکتر را از تابع اصلی دریافت کرده سپس دو ماتریس جهت ذخیره تصاویر کاراکترها و همچنین کد تکست آن کاراکتر ایجاد می کند در ادامه توسط حلقه تکرار به میزان تعداد کاراکتر از آدرس محل کارکترهای تمرین شماره ۱۹ هر کاراکتر را برداشته و درون ماتریس ذخیره میکند و در نهایت ماتریس شامل تمام کارکتر ها و همچنین کد تکست آن را به تابع main_func برمی گرداند. نکته قابل ذکر اینکه کاراکتر ها در این تابع به صورت رندم بین حروف بزرگ الفبای انگلیسی انتخاب می شوند. 

</div>

``` matlab

function [alphabet,text]=get_ch(n)
alphabet=zeros(25,25,n);
code=zeros(1,n);
i=1;
    for i=1:n
       s='A':'Z';
       str=s(randi(numel(s))); 
       add="..\..\..\excersiecs\arman-ariamehr\19\alphabet\"+str+".txt";
       code(i)=str;
       ch_arr=dlmread(add);
       alphabet(:,:,i)=ch_arr; 
       i=i+1;
    end  
    alphabet = uint8(alphabet);
    text=char(code);
    

```
***
### join_char :

<div dir="rtl">

این تابع پارامترهایی از قبیل تصویر خام تولیدی در مرحله قبل - ماتریس کاراکترها - طول و عرض تصویر و همچنین تعداد کارکترهای تصویر کپچا را به عنوان ورودی دریافت می کند  و سپس توسط حلقه تکرار هر کارکتر را توسط تابع captcha_rotate به اندازه مقداری تصادفی بین ۰ تا ۲۷۰ درجه دوران می دهد سپس توسط حلقه های تکرار تو در تو این تصاویر کارکترها را کنار هم می چسباند و در نهایت تصویر تولیدی را به تابع قبل باز می گرداند  

</div>

``` matlab
function pic=join_char(pic,alphabet,height,width,n)
for i=1:n
   r=randi(270);
   m=size(imbinarize(captcha_rotate(alphabet(:,:,i),r)));
   mm=zeros(m(1),m(2));
   mm=imbinarize(captcha_rotate(alphabet(:,:,i),r));
   mm=imresize(mm,[floor(height) floor(width/n)]);
   h=size(mm);
   for j=1:h(1)
       for k=1:h(2)
           c=(i-1)*h(2)+k;
           pic(j,c)=mm(j,k);         
       end
   end
end  
end

```
***
### captcha_rotate :

<div dir="rtl">
 
 این تابع تصویر و مقدار زاویه را به عنوان ورودی دریافت کرده و آن تصویر را به اندازه زاویه مورد نظر دوران می دهد طرز کار تابع بدین صورت است که در بخش اول پس از تعریف تابع ابعاد تصویر را محاسبه ورودی را بدست آورده و با استفاده از روابط مثلثاتی ابعاد تصویر جدید بعد از دوران را محاسبه می کند همچنین با توجه به اینکه تصویر حول مرکز دوران می کند مختصات نقطه وسط تصویر را نیز بدست می آورد سپس با استفاده از حلقه های تکرار و روابط مثلثاتی مختصات جدید هر پیکسل پس از دوران را محاسبه می کند و مقدار هر پیکسل در مختصات جدید را برابر مقدار پیکسل در مختصات قبلی قرار داده و در نهایت تصویر را به تابع قبل باز می گرداند
 
   

</div>


``` matlab
function pic2=captcha_rotate(pic,angel)
n=size(pic);
v=deg2rad(angel);
r=ceil(n(1)*abs(cos(v))+n(2)*abs(sin(v)));                      
c=ceil(n(1)*abs(sin(v))+n(2)*abs(cos(v)));                     
pic2=zeros(r,c);
pic2=uint8(pic2);
midx=ceil((size(pic2,1))/2);
midy=ceil((size(pic2,2))/2);
for i=1:size(pic2,1)
    for j=1:size(pic2,2)                                                       
         xx= round((i-midx)*cos(v)+(j-midy)*sin(v)+ceil(n(1)/2));                                       
         yy= round(-(i-midx)*sin(v)+(j-midy)*cos(v)+ceil(n(2)/2));                             
         if (xx>=1 && yy>=1 ) 
             if ( xx<=n(1) &&  yy<=n(2) ) 
               pic2(i,j)=pic(xx,yy);  
             end  
         end
    end
end
```
***
### rand_inv :

<div dir="rtl">
 
 این تابع تصویر کپچای تولیدی در مراحل قبل را به همراه مقدار طول و عرض آن دریافت کرده و سپس توسط ایجاد دو عدد تصادفی بخشی از تصویر را به حالت نگاتیو تبدیل کرده و این تغییرات را توسط حلقه های تکرار روی تصویر اصلی اعمال کرده و نهایت تصویر تولیدی را به تابع main_func بر می گرداند 

</div>


``` matlab


function pic=rand_inv(pic,height,width)
x=randi(height-50);
y=randi(width-50);
for i=20:height-20
    for j=y:min((floor(width/4)+y),width)
       pic(i,j)=1-pic(i,j);   
    end
end
end
```
***
### pepper_noise :

<div dir="rtl">
 
 این تابع تصویر ورودی به همراه میزان درصد اعمالی نویز نمک و فلفل روی تصویر ایجاد می کند. روند کار بدین صورت است که ابتدا ابعاد تصویر را بدست آورده و توسط حلقه های تکرار در مختصات تصادفی تولید شده مقدار پیکسل را به صورت تصادفی سیاه یا سفید می کند و پس از اعمال این تغییرات روی تصویر آن را به تابع main_func بر میگرداند 

</div>


``` matlab

function pic=pepper_noise(pic,ps)
n=size(pic);
px=round((ps*n(1)*n(2))/100);
for i=1:px
    x=randi(n(1));
    y=randi(n(2));
    z=round(mod(randi(10),2));
    pic(x,y)=z;
end
```
***
### تصاویر :

<div dir="rtl">
 
  در این بخش تصاویری از محیط برنامه به همراه  و همچنین تصویری از فایل اکسل تولید شده را مشاهده می کنید 

</div>

***

![alt text](https://github.com/semnan-university-ai/image-processing-class/blob/4a37abf75eea82d674436c2c95ad65bf2c99d246/final%20project/alirezachaji/Shot%200020.png)

***

![alt text](https://github.com/semnan-university-ai/image-processing-class/blob/4a37abf75eea82d674436c2c95ad65bf2c99d246/final%20project/alirezachaji/Excel_final.png)
